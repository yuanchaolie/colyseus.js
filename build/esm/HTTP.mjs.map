{"version":3,"file":"HTTP.mjs","sources":["../../src/HTTP.ts"],"sourcesContent":["import { Client } from \"./Client\";\nimport { AbortError, ServerError } from \"./errors/Errors\";\nimport * as httpie from \"@colyseus/httpie\";\n\nexport class HTTP {\n    public authToken: string;\n\n    constructor(\n        protected client: Client,\n        public headers: { [id: string]: string } = {},\n    ) {}\n\n    public get<T = any>(path: string, options: Partial<httpie.Options> = {}): Promise<httpie.Response<T>> {\n        return this.request(\"get\", path, options);\n    }\n\n    public post<T = any>(path: string, options: Partial<httpie.Options> = {}): Promise<httpie.Response<T>> {\n        return this.request(\"post\", path, options);\n    }\n\n    public del<T = any>(path: string, options: Partial<httpie.Options> = {}): Promise<httpie.Response<T>> {\n        return this.request(\"del\", path, options);\n    }\n\n    public put<T = any>(path: string, options: Partial<httpie.Options> = {}): Promise<httpie.Response<T>> {\n        return this.request(\"put\", path, options);\n    }\n\n    protected request(method: \"get\" | \"post\" | \"put\" | \"del\", path: string, options: Partial<httpie.Options> = {}): Promise<httpie.Response> {\n        return httpie[method](this.client['getHttpEndpoint'](path), this.getOptions(options)).catch((e: any) => {\n            if (e.aborted) {\n                throw new AbortError(\"Request aborted\");\n            }\n\n            const status = e.statusCode; //  || -1\n            const message = e.data?.error || e.statusMessage || e.message; //  || \"offline\"\n\n            if (!status && !message) {\n                throw e;\n            }\n\n            throw new ServerError(status, message);\n        });\n    }\n    protected request(method: \"get\" | \"post\" | \"put\" | \"del\", path: string, options: Partial<httpie.Options> = {}): Promise<httpie.Response> {\n      if (typeof (wx) !== 'undefined' && wx.connectSocket){\n        const wxOptions = this.getWxOptions(method, path, options);\n        return new Promise((resolve, reject) => {\n            wx.request({\n                ...wxOptions,\n                data:options.body || options.data,\n                success: (res) => {\n                  console.log(res);\n                  resolve(res);\n                },\n                fail: (err) => {\n                    reject(new Errors.ServerError(err.statusCode || -1, err.errMsg));\n                }\n            });\n        });\n      }else{\n        return httpie[method](this.client['getHttpEndpoint'](path), this.getOptions(options)).catch((e: any) => {\n            if (e.aborted) {\n                throw new AbortError(\"Request aborted\");\n            }\n\n            const status = e.statusCode; //  || -1\n            const message = e.data?.error || e.statusMessage || e.message; //  || \"offline\"\n\n            if (!status && !message) {\n                throw e;\n            }\n\n            throw new ServerError(status, message);\n        });\n      }\n\n    }\n\n    protected getWxOptions(method:string, path:string, options:Partial<httpie.Options>) {\n        // 合并配置\n        const mergedOptions = {\n            ...options,\n            headers: {\n                ...this.headers,\n                ...(options.headers || {})\n            }\n        };\n\n        // 添加认证令牌\n        if (this.authToken) {\n            mergedOptions.headers['Authorization'] = `Bearer ${this.authToken}`;\n        }\n\n        // 返回微信小程序支持的格式\n        return {\n            url: this.client['getHttpEndpoint'](path),\n            method: method,\n            data: mergedOptions.body || mergedOptions.data,\n            header: mergedOptions.headers,\n            timeout: mergedOptions.timeout,\n            dataType: 'json'\n        };\n    }\n\n    protected getOptions(options: Partial<httpie.Options>) {\n        // merge default custom headers with user headers\n        options.headers = Object.assign({}, this.headers, options.headers);\n\n        if (this.authToken) {\n            options.headers['Authorization'] = `Bearer ${this.authToken}`;\n        }\n\n        if (typeof (cc) !== 'undefined' && cc.sys && cc.sys.isNative) {\n            //\n            // Workaround for Cocos Creator on Native platform\n            // \"Cannot set property withCredentials of #<XMLHttpRequest> which has only a getter\"\n            //\n        } else {\n            // always include credentials\n            options.withCredentials = true;\n        }\n\n        return options;\n    }\n}\n"],"names":[],"mappings":"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"}